# 计算机体系结构

甘晴void



课程最低要求：

- 一条指令怎么执行？
- 五条指令怎么流水线执行？



计算机分类

个人设备，桌面电脑，服务器

集群，IOT

4 并行趋势

- 数据并行
- 任务并行

ISA底层

- 指令级并行ILP（ILP墙）
- TLP：数据，任务并行
- RLP：任务并行

并行分类

SISD：单指令单数据 ILP 

SIMD：单指令多数据 GPU

MISD： 不存在

MIMD： 多指令多数据 RTL

ISA（指令集架构）

①ISA的分类★

- M-M（都来自内存）现已淘汰
- R-M（ALU的操作数，一个来自寄存器，一个来自内存），X86
- R-R（ALU的操作数，都来自寄存器）可做流水线并行，ARM, RISC-V



②存储器寻址：

尾端问题（大小端）：对于0x00 11 22 33

- 大端：数字高位放地址高位 0x33 0x22 0x11 0x00
- 小端：数字高位放地址低位 0x00 0x11 0x22 0x33

对齐问题：

- 对齐性能会更好，不对齐利用率更高



③寻址模式★

- 立即数寻址：Add R4,R3
- 寄存器寻址：Add R4,3
- 寄存器间接寻址：Add R4,[R3]
- offset



④操作数（类型和大小）：

- 整型（32bit）【原码&反码&补码】，
- 浮点（64bit）【IEEE】，
- 字符型【ASCII码】，
- 半字，字（word）

示例：商业应用，为了精度，用4bit表示一个十进制数



⑤操作码：功能

- 算术与逻辑：+ - & | * /
- 数据迁移：载入，存储
- 控制类型
- system
- 浮点型
- 字符串
- 图像处理Graph

⑥控制指令

PC：ProgrammeCounter

- 条件分支
- JUMP
- 函数调用/返回



⑦编码指令

c文件 -> 二进制可执行文件

代码长度重要：变长

性能重要：固定长

RISC（整齐，适合做指令流水） <> CISC



⑧编译器

前端 --IR-> 高级优化 ---> 全局优化器 ---> 代码生成器

好的ISA：正则化，原型而非解决方案，候选项之间的权衡（很简单），编译时能确定的指令转化为常数



现代应用对ISA的期望：



RISC

构式：

基础整型：RV32I，RV64I，IMAFD=G

扩展：M(增加整数乘除),A(atomic原子),F(32位IEEE浮点，有32个浮点寄存器),D(浮点操作扩展至64位)



寄存器： 

- 32个通用寄存器 X0 .. X31（x0恒等于0，x1保存return addr）
- 32个浮点寄存器 F1 .. F31

寻址方式：寄存器寻址，立即数寻址，偏移量寻址

操作数：8bit .. 64bit

控制流指令：





1.4-1.7不讲

1.8 性能较重要

1.9

关注并行

关注：任务并行，指令并行，电路级别的并行

关注局部性：时间局部性，空间局部性 -> cache

关注最主要方向 -> 第一章

★Amdahl定律：S = 原来的时间 / 新的时间 = 1 / [ (1-F) + F/S]

F 改进比例 S 改进加速比



量化原则

性能：

- 响应速度：单个任务的完成时间
- 吞吐量：单位时间的任务数

执行时间：

- wall clock time
- CPU time

三个原则

- 提高并行度
- 利用局部性
- 关注主要的矛盾：Amdhal加速比

CPU时间 = 程序的CPU时钟周期数 / 时钟频率

★性能铁律公式：

CPU时间 = 指令数 * CPI（每条指令的时钟周期数） * 时钟周期时间



技术：

- 程序 -> 指令数
- 编译器 -> 指令数，CPI
- ISA -> 指令数，CPI
- 微架构 -> CPI，时钟周期
- 工艺 -> 时钟周期

硬件

- 摩尔定律
- 单位晶体不变
- 暗硅效应

总结

- ISA
- 一条指令的执行
- 三个量化案例
- 性能公式

流水：

- 任务划分，任务独立
- 不同的硬件，独立

理想加速比：流水线的深度

流水线->实现/微操作/部件

★Tomasulo

受限于CommonDataBus，需要高速CDB

IM Reg ALU MEM 流水线寄存器



流水线要解决的问题：

结构冒险：部件在一个周期只能执行一个任务，指令存储和数据存储分离。解决：重排，stall，Duplicate（重复拷贝），RISC没有结构冲突

数据冒险：问题：RAW,WAR,WAW。解决：stall（停顿），指令重排（软件），转发（硬件支持）。

控制冒险：解决：flush，预测（成立或不成立），延迟跳转

预测：

- taken/untaken（★要求考试能画出来，成功/失败）
- 静态，分析代码
- 运行态：1bit（2个状态机），2bit（4个状态机）

Hazard Detection

三步：

- rd写回信号（load，ALU）
- opcode field
- rd与rs1/rs2是否相等



ILP（指令集并行）

流水线

硬件：转发/分支预测，记分牌，Tomasulo，动态消歧（LD有可能指向内存同一地址）

软件：指令重排，循环



考察：不同技术在CPI公式中提升了哪些部分，从哪个角度解决了问题

map unrolling

replication

memery

renames

resheduls

